<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Recipes â€¢ pagoo</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/flatly/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Recipes">
<meta property="og:description" content="pagoo">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=UA-164668935-1"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-164668935-1');
</script>
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">pagoo</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">0.3.16</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../articles/pagoo.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Tutorials
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/Input.html">1 - Input</a>
    </li>
    <li>
      <a href="../articles/Querying_Data.html">2 - Querying Data</a>
    </li>
    <li>
      <a href="../articles/Subseting.html">3 - Subseting</a>
    </li>
    <li>
      <a href="../articles/Methods_Plots.html">4 - Methods and Plots</a>
    </li>
    <li>
      <a href="../articles/Recipes.html">5 - Recipes</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/iferres/pagoo/" class="external-link">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="Recipes_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Recipes</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/iferres/pagoo/blob/HEAD/vignettes/Recipes.Rmd" class="external-link"><code>vignettes/Recipes.Rmd</code></a></small>
      <div class="hidden name"><code>Recipes.Rmd</code></div>

    </div>

    
    
<p>Here we introduce our cookbook which is made of recipes. Each recipe is a customized piece of code to complete different advanced tasks. By using these recipes (or creating new ones) the user can take full profit of functionalities provided by <code>pagoo</code> and easily interact with other <code>R</code> packages to perform a variety of analyses including phylogenetics, pangenome-wide association studies, sequence comparisons, ecological measures, prepare publication-quality figures, among others. If you want to standardize any analysis from your pangenome data that is not covered in this tutorial, we can help you and write a recipe. Contact us!</p>
<p>Start by loading the <code>pagoo</code> object, as in previous tutorials:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://iferres.github.io/pagoo/" class="external-link">pagoo</a></span><span class="op">)</span> <span class="co"># Load package</span></span>
<span><span class="va">toy_rds</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">'extdata'</span>, <span class="st">'campylobacter.RDS'</span>, package <span class="op">=</span> <span class="st">'pagoo'</span><span class="op">)</span></span>
<span><span class="va">p</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/load_pangenomeRDS.html">load_pangenomeRDS</a></span><span class="op">(</span><span class="va">toy_rds</span><span class="op">)</span></span></code></pre></div>
<div class="section level2">
<h2 id="publication-quality-figures">Publication-quality figures<a class="anchor" aria-label="anchor" href="#publication-quality-figures"></a>
</h2>
<p>In the section <strong>5 - Methods and Plots</strong> we introduced a set of several plots that <code>pagoo</code> can generate for the basic exploration of pangenome features. These plots are generated using <code>ggplot2</code>, so their aesthetic features can be easily improved. Here we show how <code>pagoo</code> interacts with <code>ggplot2</code> and some of its extensions to produce publication-quality figures from the previous standard pangenome plots, allowing flexible styling and reproducible generation of figures. Some customization has already been shown in previous tutorials.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://patchwork.data-imaginist.com" class="external-link">patchwork</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># 1. Pangenome curves</span></span>
<span><span class="va">curves</span> <span class="op">&lt;-</span> <span class="va">p</span><span class="op">$</span><span class="fu">gg_curves</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>                                     <span class="co"># Plot core- and pan-genome curves</span></span>
<span>          <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_color_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'black'</span>, <span class="st">'black'</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>  <span class="co"># Customize line colors</span></span>
<span>          <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>alpha <span class="op">=</span> <span class="fl">.05</span>, size <span class="op">=</span> <span class="fl">4</span>, color <span class="op">=</span> <span class="st">'grey'</span><span class="op">)</span> <span class="op">+</span> <span class="co"># Add semi-transparent data points</span></span>
<span>          <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span>base_size <span class="op">=</span> <span class="fl">15</span><span class="op">)</span> <span class="op">+</span>                          <span class="co"># Customize background theme</span></span>
<span>          <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">'none'</span>,                     <span class="co"># Remove legend</span></span>
<span>        axis.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">12</span><span class="op">)</span>,                     <span class="co"># Customize axis title</span></span>
<span>        axis.text <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">12</span><span class="op">)</span><span class="op">)</span>                      <span class="co"># Customize axis text size</span></span>
<span></span>
<span><span class="co"># 2. Gene frequency bar plots</span></span>
<span><span class="va">bars</span> <span class="op">&lt;-</span> <span class="va">p</span><span class="op">$</span><span class="fu">gg_barplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>                                       <span class="co"># Plot gene frequency distribution</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span>base_size <span class="op">=</span> <span class="fl">15</span><span class="op">)</span> <span class="op">+</span>                                   <span class="co"># Customize background color</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>axis.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">12</span><span class="op">)</span>,                  <span class="co"># Customize axis label size</span></span>
<span>        axis.text<span class="op">=</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">12</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>                   <span class="co"># Customize axis text size</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html" class="external-link">geom_bar</a></span><span class="op">(</span>stat <span class="op">=</span> <span class="st">'identity'</span>, color <span class="op">=</span> <span class="st">'black'</span>, fill <span class="op">=</span> <span class="st">'black'</span><span class="op">)</span> <span class="co"># Customize bar color and borders</span></span>
<span></span>
<span><span class="co"># 3. PCA of accessory genes colored by host</span></span>
<span><span class="va">pca</span> <span class="op">&lt;-</span> <span class="va">p</span><span class="op">$</span><span class="fu">gg_pca</span><span class="op">(</span>colour <span class="op">=</span> <span class="st">'host'</span>, size <span class="op">=</span> <span class="fl">4</span><span class="op">)</span> <span class="op">+</span>                <span class="co"># Plot PCA, color by host</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span>base_size <span class="op">=</span> <span class="fl">15</span><span class="op">)</span> <span class="op">+</span>                                <span class="co"># Customize background theme</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">'bottom'</span><span class="op">)</span> <span class="op">+</span>                       <span class="co"># Customize legend position</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>axis.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">12</span><span class="op">)</span>,               <span class="co"># Customize axis title</span></span>
<span>        axis.text <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">12</span><span class="op">)</span><span class="op">)</span>                <span class="co"># Customize axis text size</span></span>
<span></span>
<span><span class="co"># 4. Pie chart of core and accessory genes</span></span>
<span><span class="va">pie</span> <span class="op">&lt;-</span> <span class="va">p</span><span class="op">$</span><span class="fu">gg_pie</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>                                         <span class="co"># Plot pie chart</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span>base_size <span class="op">=</span> <span class="fl">15</span><span class="op">)</span> <span class="op">+</span>                                <span class="co"># Customize background theme</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_colour_discrete.html" class="external-link">scale_fill_discrete</a></span><span class="op">(</span>guide <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guide_legend.html" class="external-link">guide_legend</a></span><span class="op">(</span>keywidth <span class="op">=</span> <span class="fl">.75</span>,</span>
<span>                                           keyheight <span class="op">=</span> <span class="fl">.75</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="co"># Customize fill</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_brewer.html" class="external-link">scale_fill_brewer</a></span><span class="op">(</span>palette <span class="op">=</span> <span class="st">"Blues"</span><span class="op">)</span> <span class="op">+</span>                    <span class="co"># Customize fill color</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_discrete.html" class="external-link">scale_x_discrete</a></span><span class="op">(</span>breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">25</span>, <span class="fl">50</span>, <span class="fl">75</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>             <span class="co"># Customize axis scales</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">'bottom'</span>,                         <span class="co"># Customize legend position</span></span>
<span>        legend.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,                     <span class="co"># Remove legend title</span></span>
<span>        legend.text <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">10</span><span class="op">)</span>,              <span class="co"># Change legend text size</span></span>
<span>        legend.margin <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">margin</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">13</span>, <span class="fl">0</span><span class="op">)</span>,                <span class="co"># Change legend margins</span></span>
<span>        legend.box.margin <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">margin</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">5</span>, <span class="fl">0</span><span class="op">)</span>,             <span class="co"># Change box margins</span></span>
<span>        axis.title.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,                     <span class="co"># Remove X-axis title</span></span>
<span>        axis.title.y <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,                     <span class="co"># Remove Y-axis title</span></span>
<span>        axis.ticks <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,                       <span class="co"># Remove axis ticks</span></span>
<span>        axis.text.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span>                      <span class="co"># Remove X-axis text</span></span>
<span></span>
<span></span>
<span><span class="co"># 5. Use patchwork to arrange plots using math operators</span></span>
<span><span class="op">(</span><span class="va">curves</span> <span class="op">+</span> <span class="va">bars</span><span class="op">)</span> <span class="op">/</span> <span class="op">(</span><span class="va">pca</span> <span class="op">+</span> <span class="va">pie</span><span class="op">)</span></span></code></pre></div>
<p><img src="Recipes_files/figure-html/unnamed-chunk-2-1.png" width="700"></p>
<div class="section level3">
<h3 id="using-micropan-methods">Using <code>micropan</code> Methods<a class="anchor" aria-label="anchor" href="#using-micropan-methods"></a>
</h3>
<div class="section level4">
<h4 id="estimation-of-core-and-pangenome-sizes">Estimation of Core and Pangenome Sizes<a class="anchor" aria-label="anchor" href="#estimation-of-core-and-pangenome-sizes"></a>
</h4>
<p>Given a panmatrix, you could predict the number of core clusters and the total number of clusters in a pangenome. Several methods have been developed for this purpose, in this case a binomial mixture model implemented by <code>micropan</code> package is used to describe the distribution of gene clusters across genomes in a pangenome.</p>
<p>To use this method, simply pass the objectâ€™s pan-matrix to the <code><a href="https://rdrr.io/pkg/micropan/man/binomixEstimate.html" class="external-link">micropan::binomixEstimate</a></code> function:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">micropan</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">micropan</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/micropan/man/binomixEstimate.html" class="external-link">binomixEstimate</a></span><span class="op">(</span><span class="va">p</span><span class="op">$</span><span class="va">pan_matrix</span><span class="op">)</span></span></code></pre></div>
<p>Given that we are using a very small toy dataset, results here are not really meaningful.</p>
</div>
<div class="section level4">
<h4 id="fluidity">Fluidity<a class="anchor" aria-label="anchor" href="#fluidity"></a>
</h4>
<p>Genomic fluidity is a measure of population diversity. Itâ€™s somehow similar to computing jaccard distances, but genomic fluidity describes the whole population whereas jaccard distances are computed pairwise. As above, we are passing the objectâ€™s pan-matrix to the <code><a href="https://rdrr.io/pkg/micropan/man/fluidity.html" class="external-link">micropan::fluidity</a></code> function. In this case, lets use <code>magrittr</code>â€™s <code>%&gt;%</code> operator to pipe it, and compute fluidity using 100 random samples:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">micropan</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://magrittr.tidyverse.org" class="external-link">magrittr</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">p</span><span class="op">$</span><span class="va">pan_matrix</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu">micropan</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/micropan/man/fluidity.html" class="external-link">fluidity</a></span><span class="op">(</span>n.sim <span class="op">=</span> <span class="fl">100</span><span class="op">)</span></span></code></pre></div>
</div>
</div>
</div>
<div class="section level2">
<h2 id="annotate-clusters">Annotate clusters<a class="anchor" aria-label="anchor" href="#annotate-clusters"></a>
</h2>
<p>A common practice to improve the annotation quality of the pangenome is to retrieve a single representative sequence of each cluster and to â€˜blastâ€™ it against a given database. The best hits annotation is then transferred to the clusters. The EggNOG database is a very comprehensive and well curated resource which includes annotation from many other databases (e.g.Â KEGG, COG, CAZy, etc), and the eggnog-mapper tool allows to easily transfer their annotation to any given query sequence.</p>
<p>This recipe shows how to write a multi-fasta file containing one representative sequence of each cluster to annotate with the EggNOG-mapper tool, and then it shows how to add this new information to the pangenome object.</p>
<p>The first step is to retrieve a single representative sequence from each cluster, then to translate them, and finally to write them to a multi-fasta file:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">p</span><span class="op">$</span><span class="va">sequences</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>                                     <span class="co"># Get the sequences</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="st">"[["</span>, <span class="fl">1</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>                               <span class="co"># Select the first one as representative.</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/unlist.html" class="external-link">unlist</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>                                      <span class="co"># Unlist and..</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/Biostrings/man/XStringSet-class.html" class="external-link">DNAStringSet</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>                                <span class="co"># ..transform to DNAStringSet.</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/microseq/man/translate.html" class="external-link">translate</a></span><span class="op">(</span>if.fuzzy.codon <span class="op">=</span> <span class="st">"solve"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>           <span class="co"># Translate.</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/Biostrings/man/XStringSet-io.html" class="external-link">writeXStringSet</a></span><span class="op">(</span>filepath <span class="op">=</span> <span class="st">"representatives.fasta"</span><span class="op">)</span> <span class="co"># Write a fasta file.</span></span></code></pre></div>
<p>Now the user has to provide the <code>representatives.fasta</code> as input file to the eggnog-mapper. This can be done through the <a href="http://eggnog5.embl.de/#/app/home" class="external-link">web server</a>, or through the command line if it is installed. The command (on your terminal) would look somewhat like this:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb6-1"><a href="#cb6-1"></a><span class="ex">emapper.py</span> -i representative.fasta -o representative_emapper</span></code></pre></div>
<p>Then we have to read the <code>*.emapper.annotations</code> file into the R session, and feed the pangenome object with its information:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://magrittr.tidyverse.org" class="external-link">magrittr</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Read the annotations file</span></span>
<span><span class="va">emap</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html" class="external-link">read.csv</a></span><span class="op">(</span><span class="st">"representatives.emapper.annotations"</span>,</span>
<span>                 sep <span class="op">=</span> <span class="st">"\t"</span>,</span>
<span>                 comment.char <span class="op">=</span> <span class="st">"#"</span>,</span>
<span>                 header <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>                 na.strings <span class="op">=</span> <span class="st">"-"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Set column names</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/row_colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">emap</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"query"</span>, <span class="st">"seed_ortholog"</span>, <span class="st">"evalue"</span>, <span class="st">"score"</span>, <span class="st">"eggNOG_OGs"</span>,</span>
<span>                    <span class="st">"max_annot_lvl"</span>, <span class="st">"COG_category"</span>, <span class="st">"Description"</span>, <span class="st">"Preferred_name"</span>,</span>
<span>                    <span class="st">"GOs"</span>, <span class="st">"EC"</span>, <span class="st">"KEGG_ko"</span>, <span class="st">"KEGG_Pathway"</span>, <span class="st">"KEGG_Module"</span>, <span class="st">"KE"</span>,</span>
<span>                    <span class="st">"GG_Reaction"</span>, <span class="st">"KEGG_rclass"</span>, <span class="st">"BRITE"</span>, <span class="st">"CAZy"</span>,</span>
<span>                    <span class="st">"BiGG_Reaction"</span>, <span class="st">"PFAMs"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Lets take only some of them which I usually find useful. Subset the data.frame:</span></span>
<span><span class="va">cluster_meta</span> <span class="op">&lt;-</span> <span class="va">emap</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"query"</span>, <span class="st">"COG_category"</span>, <span class="st">"KEGG_ko"</span>, <span class="st">"CAZy"</span><span class="op">)</span><span class="op">]</span></span>
<span></span>
<span><span class="co"># Clean and parse the fields before feeding it to the pangenome</span></span>
<span><span class="va">cluster_meta</span><span class="op">$</span><span class="va">COG_category</span> <span class="op">&lt;-</span> <span class="va">cluster_meta</span><span class="op">$</span><span class="va">COG_category</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/strsplit.html" class="external-link">strsplit</a></span><span class="op">(</span><span class="st">""</span><span class="op">)</span></span>
<span><span class="va">cluster_meta</span><span class="op">$</span><span class="va">KEGG_ko</span> <span class="op">&lt;-</span> <span class="va">clusert_meta</span><span class="op">$</span><span class="va">KEGG_ko</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">gsub</a></span><span class="op">(</span><span class="st">"ko:"</span>, <span class="st">""</span>, <span class="va">.</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/strsplit.html" class="external-link">strsplit</a></span><span class="op">(</span><span class="st">","</span><span class="op">)</span></span>
<span><span class="va">cluster_meta</span><span class="op">$</span><span class="va">CAZy</span> <span class="op">&lt;-</span> <span class="va">cluster_meta</span><span class="op">$</span><span class="va">CAZy</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/strsplit.html" class="external-link">strsplit</a></span><span class="op">(</span><span class="st">""</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Add the metadata to the pangenome clusters</span></span>
<span><span class="va">p</span><span class="op">$</span><span class="fu">add_metadata</span><span class="op">(</span><span class="st">"cluster"</span>, <span class="va">cluster_meta</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Now the object contains the new information in the clusters field:</span></span>
<span><span class="va">p</span><span class="op">$</span><span class="va">clusters</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="neutral-genes">Neutral genes<a class="anchor" aria-label="anchor" href="#neutral-genes"></a>
</h2>
<p>The core genome is composed by those genes that are present in every or almost every genome in the sample. As these genes are present in all genomes, they can be used to extract important biological information like phylogenetic relationships, study recombination or selective pressures. For doing these, core genes need to be aligned. In the next few sections we explain how to do this to perform some of the above mentioned downstream analyses.</p>
<p>To reveal the vertical evolutionary history of a bacterial population we should take into account the presence of horizontal acquisition of genetic material, like by means of recombination, that is maintained by the action of natural selection. Hence, we can use the Tajimaâ€™s D test of neutrality as implemented in <code>pegas</code> ( <a href="https://academic.oup.com/bioinformatics/article/26/3/419/215731" class="external-link">Paradis, 2010</a>) to identify those core genes that are not subjected to strong selective pressures and are likely evolving neutrally.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Load required packages</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://magrittr.tidyverse.org" class="external-link">magrittr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">DECIPHER</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="http://ape-package.ird.fr/pegas.html" class="external-link">pegas</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="http://ape-package.ird.fr/" class="external-link">ape</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">p</span><span class="op">$</span><span class="va">core_level</span> <span class="op">&lt;-</span> <span class="fl">100</span>                       <span class="co"># Set core_level to 100% to avoid </span></span>
<span>                                          <span class="co">#  AlignTranslation() errors.</span></span>
<span></span>
<span><span class="va">tajimaD</span> <span class="op">&lt;-</span> <span class="va">p</span><span class="op">$</span><span class="fu">core_seqs_4_phylo</span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>      <span class="co"># Core genome sequences</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fu">DECIPHER</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/DECIPHER/man/AlignTranslation.html" class="external-link">AlignTranslation</a></span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>  <span class="co"># Align translation</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fu">ape</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/ape/man/as.alignment.html" class="external-link">as.DNAbin</a></span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>              <span class="co"># Transform class to DNAbin</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fu">pegas</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/pegas/man/tajima.test.html" class="external-link">tajima.test</a></span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>          <span class="co"># Compute Tajima's test</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="st">'[['</span>, <span class="st">'D'</span><span class="op">)</span>                       <span class="co"># Get Tajima's 'D' statistic from each</span></span>
<span></span>
<span><span class="co"># Which are neutral?</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">tajimaD</span> <span class="op">&lt;=</span> <span class="fl">0.2</span> <span class="op">&amp;</span> <span class="va">tajimaD</span> <span class="op">&gt;=</span> <span class="op">-</span><span class="fl">0.2</span><span class="op">)</span>  </span></code></pre></div>
</div>
<div class="section level2">
<h2 id="quick-dirty-phylogeny">Quick dirty phylogeny<a class="anchor" aria-label="anchor" href="#quick-dirty-phylogeny"></a>
</h2>
<p>The best practices on how to build a phylogeny from core genomes is a topic of debate. In this first example we provide a one-liner to align individual core genes (like in the previous case), produce a concatenated core genome alignment, calculate a core genome phylogeny using the Neighbor-Joining method as implemented by <code>phangorn</code> (Schliep, 2011), and visualize it using host metadata to color tree tips using <code>ggtree</code> (Yu et al., 2017). Phylogenetic tree is assigned to the <code>phy</code> variable, and plotted as side effect by using magrittrâ€™s <code>%T&gt;%</code> operator.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Load required packages</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://magrittr.tidyverse.org" class="external-link">magrittr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">DECIPHER</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://bioconductor.org/packages/Biostrings" class="external-link">Biostrings</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/KlausVigo/phangorn" class="external-link">phangorn</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">ggtree</span><span class="op">)</span></span>
<span></span>
<span><span class="va">phy</span> <span class="op">&lt;-</span> <span class="va">p</span><span class="op">$</span><span class="fu">core_seqs_4_phylo</span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>                 <span class="co"># Core genome sequences</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fu">DECIPHER</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/DECIPHER/man/AlignSeqs.html" class="external-link">AlignSeqs</a></span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>                <span class="co"># Align</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/do.call.html" class="external-link">do.call</a></span><span class="op">(</span><span class="fu">Biostrings</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/Biostrings/man/xscat.html" class="external-link">xscat</a></span>, <span class="va">.</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>              <span class="co"># Concatenate alignments</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/setNames.html" class="external-link">setNames</a></span><span class="op">(</span><span class="va">p</span><span class="op">$</span><span class="va">organisms</span><span class="op">$</span><span class="va">org</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>                  <span class="co"># Set sequence names</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/methods/as.html" class="external-link">as</a></span><span class="op">(</span><span class="st">'matrix'</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>                               <span class="co"># Transform to matrix</span></span>
<span>  <span class="fu">phangorn</span><span class="fu">::</span><span class="fu"><a href="https://klausvigo.github.io/phangorn/reference/as.phyDat.html" class="external-link">phyDat</a></span><span class="op">(</span>type <span class="op">=</span> <span class="st">'DNA'</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>             <span class="co"># Transform to phangorn's phyDat</span></span>
<span>  <span class="fu">phangorn</span><span class="fu">::</span><span class="fu"><a href="https://klausvigo.github.io/phangorn/reference/dist.hamming.html" class="external-link">dist.ml</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>                        <span class="co"># Compute distance</span></span>
<span>  <span class="fu">phangorn</span><span class="fu">::</span><span class="fu"><a href="https://klausvigo.github.io/phangorn/reference/NJ.html" class="external-link">NJ</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/tee.html" class="external-link">%T&gt;%</a></span> <span class="op">{</span>                          <span class="co"># Compute NJ, and assign "phy"</span></span>
<span>    <span class="op">{</span></span>
<span>      <span class="fu">ggtree</span><span class="fu">::</span><span class="fu">ggtree</span><span class="op">(</span><span class="va">.</span><span class="op">)</span> <span class="op">%&lt;+%</span>                        <span class="co"># Create ggtree</span></span>
<span>        <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="va">p</span><span class="op">$</span><span class="va">organisms</span><span class="op">)</span> <span class="op">+</span>                <span class="co"># Get organisms metadata</span></span>
<span>        <span class="fu">ggtree</span><span class="fu">::</span><span class="fu">geom_tippoint</span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>colour <span class="op">=</span> <span class="va">host</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="co"># Add coloured tip points</span></span>
<span>        <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_brewer.html" class="external-link">scale_color_brewer</a></span><span class="op">(</span>palette <span class="op">=</span> <span class="st">'Set1'</span><span class="op">)</span>        <span class="co"># Set color palette</span></span>
<span>    <span class="op">}</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="maximum-likelihood-phylogeny">Maximum Likelihood phylogeny<a class="anchor" aria-label="anchor" href="#maximum-likelihood-phylogeny"></a>
</h2>
<p>The following method is similar to the previous, but in this case we are optimizing the topology and branch lengths by maximum likelihood method implemented in <code>phangorn</code> package. Although this is a fully working example, its purpose is just to illustrate the idea. You should consider tuning the parameters to better fit your dataset (e.g.: just 4 discrete gamma distributions for a whole coregenome alignment may be too low).</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Load required packages</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://magrittr.tidyverse.org" class="external-link">magrittr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">DECIPHER</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://bioconductor.org/packages/Biostrings" class="external-link">Biostrings</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/KlausVigo/phangorn" class="external-link">phangorn</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">ggtree</span><span class="op">)</span></span>
<span></span>
<span><span class="va">phy</span> <span class="op">&lt;-</span> <span class="va">p</span><span class="op">$</span><span class="fu">core_seqs_4_phylo</span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>                 <span class="co"># Core genome sequences</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fu">DECIPHER</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/DECIPHER/man/AlignSeqs.html" class="external-link">AlignSeqs</a></span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>                <span class="co"># Align</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/do.call.html" class="external-link">do.call</a></span><span class="op">(</span><span class="fu">Biostrings</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/Biostrings/man/xscat.html" class="external-link">xscat</a></span>, <span class="va">.</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>              <span class="co"># Concatenate alignments</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/setNames.html" class="external-link">setNames</a></span><span class="op">(</span><span class="va">p</span><span class="op">$</span><span class="va">organisms</span><span class="op">$</span><span class="va">org</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>                  <span class="co"># Set sequence names</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/methods/as.html" class="external-link">as</a></span><span class="op">(</span><span class="st">'matrix'</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>                               <span class="co"># Transform to matrix</span></span>
<span>  <span class="fu">phangorn</span><span class="fu">::</span><span class="fu"><a href="https://klausvigo.github.io/phangorn/reference/as.phyDat.html" class="external-link">phyDat</a></span><span class="op">(</span>type <span class="op">=</span> <span class="st">'DNA'</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/tee.html" class="external-link">%T&gt;%</a></span>            <span class="co"># Transform to phangorn's phyDat</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/assign.html" class="external-link">assign</a></span><span class="op">(</span><span class="st">'dat'</span>, <span class="va">.</span>, <span class="va">.GlobalEnv</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>               <span class="co"># Assign to "dat" in .GlobalEnv</span></span>
<span>  <span class="fu">phangorn</span><span class="fu">::</span><span class="fu"><a href="https://klausvigo.github.io/phangorn/reference/dist.hamming.html" class="external-link">dist.ml</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>                        <span class="co"># Compute distance</span></span>
<span>  <span class="fu">phangorn</span><span class="fu">::</span><span class="fu"><a href="https://klausvigo.github.io/phangorn/reference/NJ.html" class="external-link">NJ</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>                             <span class="co"># Compute NJ (initial tree)</span></span>
<span>  <span class="fu">phangorn</span><span class="fu">::</span><span class="fu"><a href="https://klausvigo.github.io/phangorn/reference/pml.html" class="external-link">pml</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">dat</span>, k <span class="op">=</span> <span class="fl">4</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>           <span class="co"># Compute likelihood with 4 discrete</span></span>
<span>                                                 <span class="co">#  gamma distributions. </span></span>
<span>  <span class="fu">phangorn</span><span class="fu">::</span><span class="fu"><a href="https://klausvigo.github.io/phangorn/reference/pml.html" class="external-link">optim.pml</a></span><span class="op">(</span>rearrangement <span class="op">=</span> <span class="st">"stochastic"</span>, <span class="co"># Optimize likelihood with</span></span>
<span>                                                 <span class="co"># stochastic rearrangements,</span></span>
<span>                      optGamma <span class="op">=</span> <span class="cn">TRUE</span>,           <span class="co"># optimize gamma rate parameter,</span></span>
<span>                      optInv <span class="op">=</span> <span class="cn">TRUE</span>,             <span class="co"># optimize prop of variable size,</span></span>
<span>                      model <span class="op">=</span><span class="st">"GTR"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>          <span class="co"># and use "GTR" model.</span></span>
<span>  <span class="fu">magrittr</span><span class="fu">::</span><span class="fu"><a href="https://magrittr.tidyverse.org/reference/aliases.html" class="external-link">extract2</a></span><span class="op">(</span><span class="st">"tree"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/tee.html" class="external-link">%T&gt;%</a></span> <span class="op">{</span>              <span class="co"># Extract the tree only, and pass</span></span>
<span>    <span class="op">{</span>                                            <span class="co">#  it to ggtree.</span></span>
<span>      <span class="fu">ggtree</span><span class="fu">::</span><span class="fu">ggtree</span><span class="op">(</span><span class="va">.</span><span class="op">)</span> <span class="op">%&lt;+%</span>                        <span class="co"># Create ggtree</span></span>
<span>        <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="va">p</span><span class="op">$</span><span class="va">organisms</span><span class="op">)</span> <span class="op">+</span>                <span class="co"># Get organisms metadata</span></span>
<span>        <span class="fu">ggtree</span><span class="fu">::</span><span class="fu">geom_tippoint</span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>colour <span class="op">=</span> <span class="va">host</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="co"># Add coloured tip points</span></span>
<span>        <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_brewer.html" class="external-link">scale_color_brewer</a></span><span class="op">(</span>palette <span class="op">=</span> <span class="st">'Set1'</span><span class="op">)</span>        <span class="co"># Set color palette</span></span>
<span>    <span class="op">}</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="population-structure">Population structure<a class="anchor" aria-label="anchor" href="#population-structure"></a>
</h2>
<p>Identifying population structure from genomic information is a common problem in microbial ecology. This aims to identify discrete sub-populations within a more heterogeneous population, which is helpful to detect associations with particular phenotypes, geographic origin, host-association, etc. There are various methods for doing this, but probably the most used in microbial genomics is <a href="https://academic.oup.com/mbe/article/30/5/1224/998212" class="external-link">hierBAPS</a> (Cheng et al., 2013) which has been re-implemented in <code>R</code> as <a href="https://wellcomeopenresearch.org/articles/3-93/v1" class="external-link">rhierBAPS</a> (Tonkin-Hill et al., 2018). In the following recipe we will combine previous examples to 1) align core clusters; 2) compute Tajimaâ€™s D statistic over aligned core clusters to identify the ones that are likely to be evolving neutrally; 3) concatenate selected neutral clusters; 4) Run the hierBAPS algorithm; 5) extract lineage information and add it to the <code>pagoo</code> object as organismâ€™s metadata; and 6) compute and plot a tree with lineage information as colour tips.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://magrittr.tidyverse.org" class="external-link">magrittr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">DECIPHER</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/gtonkinhill/rhierbaps" class="external-link">rhierbaps</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="http://ape-package.ird.fr/" class="external-link">ape</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/KlausVigo/phangorn" class="external-link">phangorn</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># 0. Always use core_level at 100% when using DECIPHER::AlignTranslation()</span></span>
<span><span class="va">p</span><span class="op">$</span><span class="va">core_level</span> <span class="op">&lt;-</span> <span class="fl">100</span></span>
<span></span>
<span><span class="co"># 1. Align translation of core genes</span></span>
<span><span class="va">ali</span> <span class="op">&lt;-</span> <span class="va">p</span><span class="op">$</span><span class="fu">core_seqs_4_phylo</span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>           <span class="co"># Core genome sequences</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fu">DECIPHER</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/DECIPHER/man/AlignTranslation.html" class="external-link">AlignTranslation</a></span><span class="op">)</span>       <span class="co"># Align translation</span></span>
<span></span>
<span><span class="co"># 2. Identify neutral core clusters</span></span>
<span><span class="va">tajD</span> <span class="op">&lt;-</span> <span class="va">ali</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fu">ape</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/ape/man/as.alignment.html" class="external-link">as.DNAbin</a></span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>              <span class="co"># Transform class to DNAbin</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fu">pegas</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/pegas/man/tajima.test.html" class="external-link">tajima.test</a></span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>          <span class="co"># Compute Tajima's test</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="st">'[['</span>, <span class="st">'D'</span><span class="op">)</span>                       <span class="co"># Subset D statistic </span></span>
<span><span class="va">neutral</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">tajD</span> <span class="op">&lt;=</span> <span class="fl">2</span> <span class="op">&amp;</span> <span class="va">tajD</span> <span class="op">&gt;=</span> <span class="op">-</span><span class="fl">2</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># 3. Concatenate neutral core clusters</span></span>
<span><span class="va">concat_neu</span> <span class="op">&lt;-</span> <span class="va">ali</span><span class="op">[</span><span class="va">neutral</span><span class="op">]</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>            <span class="co"># Select neutral clusters</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/do.call.html" class="external-link">do.call</a></span><span class="op">(</span><span class="fu">Biostrings</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/Biostrings/man/xscat.html" class="external-link">xscat</a></span>, <span class="va">.</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>       <span class="co"># Concatenate alignments</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/setNames.html" class="external-link">setNames</a></span><span class="op">(</span><span class="va">p</span><span class="op">$</span><span class="va">organisms</span><span class="op">$</span><span class="va">org</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>           <span class="co"># Set sequence names</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/methods/as.html" class="external-link">as</a></span><span class="op">(</span><span class="st">'matrix'</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>                        <span class="co"># Transform to matrix</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/chartr.html" class="external-link">tolower</a></span><span class="op">(</span><span class="op">)</span>                               <span class="co"># Translate to lower case</span></span>
<span></span>
<span><span class="co"># 4. Compute structure</span></span>
<span><span class="va">rhb</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/rhierbaps/man/hierBAPS.html" class="external-link">hierBAPS</a></span><span class="op">(</span>snp.matrix <span class="op">=</span> <span class="va">concat_neu</span>, <span class="co"># Input matrix alignment</span></span>
<span>                n.pops <span class="op">=</span> <span class="fl">10</span>,             <span class="co"># Max number of subpopulations</span></span>
<span>                max.depth <span class="op">=</span> <span class="fl">1</span>,           <span class="co"># Max depth for hierarchical clustering</span></span>
<span>                n.extra.rounds <span class="op">=</span> <span class="fl">5</span><span class="op">)</span>      <span class="co"># Extra rounds to ensure convergence</span></span>
<span></span>
<span><span class="co"># 5. Add lineage as metadata to organisms in pagoo object</span></span>
<span><span class="va">res</span> <span class="op">&lt;-</span> <span class="va">rhb</span><span class="op">$</span><span class="va">partition.df</span></span>
<span><span class="va">lin</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>org <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="va">res</span><span class="op">[</span>, <span class="fl">1</span><span class="op">]</span><span class="op">)</span>, </span>
<span>                  lineage <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">res</span><span class="op">[</span>, <span class="fl">2</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">p</span><span class="op">$</span><span class="fu">add_metadata</span><span class="op">(</span>map <span class="op">=</span> <span class="st">'org'</span>, data <span class="op">=</span> <span class="va">lin</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># 6. Compute tree and plot it with lineage information</span></span>
<span><span class="va">concat_neu</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu">phangorn</span><span class="fu">::</span><span class="fu"><a href="https://klausvigo.github.io/phangorn/reference/as.phyDat.html" class="external-link">phyDat</a></span><span class="op">(</span>type <span class="op">=</span> <span class="st">'DNA'</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>                <span class="co"># Transform to phangorn's phyDat</span></span>
<span>  <span class="fu">phangorn</span><span class="fu">::</span><span class="fu"><a href="https://klausvigo.github.io/phangorn/reference/dist.hamming.html" class="external-link">dist.ml</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>                           <span class="co"># Compute distance</span></span>
<span>  <span class="fu">phangorn</span><span class="fu">::</span><span class="fu"><a href="https://klausvigo.github.io/phangorn/reference/NJ.html" class="external-link">NJ</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>                                <span class="co"># Compute NJ</span></span>
<span>  <span class="fu">ggtree</span><span class="fu">::</span><span class="fu">ggtree</span><span class="op">(</span><span class="op">)</span> <span class="op">%&lt;+%</span>                             <span class="co"># Create ggtree</span></span>
<span>     <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="va">p</span><span class="op">$</span><span class="va">organisms</span><span class="op">)</span> <span class="op">+</span>                   <span class="co"># Get organisms metadata</span></span>
<span>     <span class="fu">ggtree</span><span class="fu">::</span><span class="fu">geom_tippoint</span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>colour <span class="op">=</span> <span class="va">lineage</span><span class="op">)</span><span class="op">)</span>   <span class="co"># Colour tips with lineage info</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="pairwise-distance-vs-pairwise-nucleotide-diversity">Pairwise distance vs pairwise nucleotide diversity<a class="anchor" aria-label="anchor" href="#pairwise-distance-vs-pairwise-nucleotide-diversity"></a>
</h2>
<p>The following recipe computes accessory genome jaccardâ€™s distance and nucleotide diversity of synonym sites for each pair of genomes, and then plot it with a linear regression curve. This method provides insights of accessory genome adaptative evolution. If both magnitudes are not correlated, it could mean that there are some selective pressures shaping cladeâ€™s evolution. It first sets the <code>core_level</code> threshold to 100%, then creates a matrix to store pairwise distances and synonym nucleotide diversities. Accessory genome Jaccard distance between each pair of organisms is computed by a <code>pagoo</code> method which is basically a wrapper of <code><a href="https://rdrr.io/pkg/vegan/man/vegdist.html" class="external-link">vegan::vegdist</a></code> function. Then there is a long code block with the method to align each core gene and select their polymorphic synonym sites. With this input, pairwise nucleotide diversity is computed with <code><a href="https://rdrr.io/pkg/pegas/man/nuc.div.html" class="external-link">pegas::nuc.div</a></code> function. At the end, a correlation between both magnitudes is plotted.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://magrittr.tidyverse.org" class="external-link">magrittr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://bioconductor.org/packages/IRanges" class="external-link">IRanges</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://bioconductor.org/packages/Biostrings" class="external-link">Biostrings</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">DECIPHER</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="http://ape-package.ird.fr/" class="external-link">ape</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="http://ape-package.ird.fr/pegas.html" class="external-link">pegas</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Set core level to 100%. This recipe only works if this is set to 100%.</span></span>
<span><span class="va">p</span><span class="op">$</span><span class="va">core_level</span> <span class="op">&lt;-</span> <span class="fl">100</span></span>
<span></span>
<span><span class="co"># Create pairs matrix</span></span>
<span><span class="va">pairs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/t.html" class="external-link">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/combn.html" class="external-link">combn</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">p</span><span class="op">$</span><span class="va">organisms</span><span class="op">)</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/row_colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">pairs</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'org1'</span>, <span class="st">'org2'</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Compute paired jaccard similarity, transform to matrix</span></span>
<span><span class="va">jaccard_sim</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="va">p</span><span class="op">$</span><span class="fu">dist</span><span class="op">(</span>method <span class="op">=</span> <span class="st">"jaccard"</span>, binary <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># Fill results matrix</span></span>
<span><span class="va">pairs</span><span class="op">$</span><span class="va">jaccard_sim</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">pairs</span>, <span class="fl">1</span>, <span class="kw">function</span><span class="op">(</span><span class="va">i</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">ii</span> <span class="op">&lt;-</span> <span class="va">i</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span></span>
<span>  <span class="va">jj</span> <span class="op">&lt;-</span> <span class="va">i</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span></span>
<span>  <span class="va">jaccard_sim</span><span class="op">[</span><span class="va">ii</span>, <span class="va">jj</span><span class="op">]</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Return only synonymous polymorphic sites.</span></span>
<span><span class="co"># First, it removes non-synonymous codons, and then retains only</span></span>
<span><span class="co"># polymorphyc sites.</span></span>
<span><span class="va">syn_poly_sites</span> <span class="op">&lt;-</span> <span class="va">p</span><span class="op">$</span><span class="fu">core_seqs_4_phylo</span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">lns</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/S4Vectors/man/List-class.html" class="external-link">elementNROWS</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>                              <span class="co"># Align translatation filtering</span></span>
<span>    <span class="va">tali</span> <span class="op">&lt;-</span> <span class="va">x</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">lns</span> <span class="op">!=</span> <span class="fl">0</span><span class="op">)</span><span class="op">]</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>                      <span class="co">#  truncated codons and returning</span></span>
<span>      <span class="fu">Biostrings</span><span class="fu">::</span><span class="fu">subseq</span><span class="op">(</span><span class="fl">1L</span>, <span class="va">lns</span> <span class="op"><a href="https://rdrr.io/r/base/Arithmetic.html" class="external-link">%/%</a></span> <span class="fl">3</span> <span class="op">*</span> <span class="fl">3</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>         <span class="co">#  both DNA and AA alignments.</span></span>
<span>      <span class="fu">DECIPHER</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/DECIPHER/man/AlignTranslation.html" class="external-link">AlignTranslation</a></span><span class="op">(</span>type <span class="op">=</span> <span class="st">"both"</span><span class="op">)</span></span>
<span>    <span class="va">syno</span> <span class="op">&lt;-</span>  <span class="va">tali</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>                              <span class="co"># Identify non-synonymous</span></span>
<span>      <span class="fu">Biostrings</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/Biostrings/man/letterFrequency.html" class="external-link">consensusMatrix</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>                 <span class="co">#  codons.</span></span>
<span>      <span class="fu">magrittr</span><span class="fu">::</span><span class="fu"><a href="https://magrittr.tidyverse.org/reference/aliases.html" class="external-link">equals</a></span><span class="op">(</span><span class="fl">0</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>      <span class="fu">magrittr</span><span class="fu">::</span><span class="fu"><a href="https://magrittr.tidyverse.org/reference/aliases.html" class="external-link">not</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>      <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/colSums.html" class="external-link">colSums</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>      <span class="fu">magrittr</span><span class="fu">::</span><span class="fu"><a href="https://magrittr.tidyverse.org/reference/aliases.html" class="external-link">equals</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>      <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/which.html" class="external-link">which</a></span><span class="op">(</span><span class="op">)</span></span>
<span>    <span class="va">neut</span> <span class="op">&lt;-</span> <span class="va">tali</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>                               <span class="co"># Remove non-synonymous codons.</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">{</span></span>
<span>        <span class="fu">IRanges</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/IRanges/man/Views-class.html" class="external-link">successiveViews</a></span><span class="op">(</span></span>
<span>          <span class="va">x</span>, <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/rep.html" class="external-link">rep.int</a></span><span class="op">(</span><span class="fl">3L</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/Arithmetic.html" class="external-link">%/%</a></span> <span class="fl">3L</span><span class="op">)</span><span class="op">)</span></span>
<span>      <span class="op">}</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>      <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="st">'['</span>, <span class="va">syno</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>      <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">unlist</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>      <span class="fu">Biostrings</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/Biostrings/man/XStringSet-class.html" class="external-link">DNAStringSet</a></span><span class="op">(</span><span class="op">)</span></span>
<span>    <span class="va">poly</span> <span class="op">&lt;-</span> <span class="va">neut</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>                                   <span class="co"># Identify polymorphic sites.</span></span>
<span>      <span class="fu">Biostrings</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/Biostrings/man/letterFrequency.html" class="external-link">consensusMatrix</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>      <span class="fu">magrittr</span><span class="fu">::</span><span class="fu"><a href="https://magrittr.tidyverse.org/reference/aliases.html" class="external-link">equals</a></span><span class="op">(</span><span class="fl">0</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>      <span class="fu">magrittr</span><span class="fu">::</span><span class="fu"><a href="https://magrittr.tidyverse.org/reference/aliases.html" class="external-link">not</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>      <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/colSums.html" class="external-link">colSums</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>      <span class="fu">magrittr</span><span class="fu">::</span><span class="fu"><a href="https://magrittr.tidyverse.org/reference/aliases.html" class="external-link">is_greater_than</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>      <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/which.html" class="external-link">which</a></span><span class="op">(</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">neut</span>, <span class="st">'['</span>, <span class="va">poly</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>                        <span class="co"># Retain only polymorphic</span></span>
<span>      <span class="fu">Biostrings</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/Biostrings/man/XStringSet-class.html" class="external-link">DNAStringSet</a></span><span class="op">(</span><span class="op">)</span>                       <span class="co">#  sites</span></span>
<span>  <span class="op">}</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/do.call.html" class="external-link">do.call</a></span><span class="op">(</span><span class="fu">Biostrings</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/Biostrings/man/xscat.html" class="external-link">xscat</a></span>, <span class="va">.</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>                    <span class="co"># Concatenate.</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/setNames.html" class="external-link">setNames</a></span><span class="op">(</span><span class="va">p</span><span class="op">$</span><span class="va">organisms</span><span class="op">$</span><span class="va">org</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>                        <span class="co"># Set names.</span></span>
<span>  <span class="fu">ape</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/ape/man/as.alignment.html" class="external-link">as.DNAbin</a></span><span class="op">(</span><span class="op">)</span>                                     <span class="co"># Convert to DNAbin class.</span></span>
<span></span>
<span><span class="co"># Compute paired nucleotide diversity, and fill results matrix</span></span>
<span><span class="va">pairs</span><span class="op">$</span><span class="va">nuc_div</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">pairs</span>, <span class="fl">1</span>, <span class="kw">function</span><span class="op">(</span><span class="va">i</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">ii</span> <span class="op">&lt;-</span> <span class="va">i</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span></span>
<span>  <span class="va">jj</span> <span class="op">&lt;-</span> <span class="va">i</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span></span>
<span>  <span class="va">pair</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">syn_poly_sites</span><span class="op">[</span><span class="va">ii</span><span class="op">]</span>, <span class="va">syn_poly_sites</span><span class="op">[</span><span class="va">jj</span><span class="op">]</span><span class="op">)</span></span>
<span>  <span class="fu">pegas</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/pegas/man/nuc.div.html" class="external-link">nuc.div</a></span><span class="op">(</span><span class="va">pair</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Plot correlation with R-base graphics</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">jaccard_sim</span> <span class="op">~</span> <span class="va">nuc_div</span>, <span class="va">pairs</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/abline.html" class="external-link">abline</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="va">jaccard_sim</span> <span class="op">~</span> <span class="va">nuc_div</span>, <span class="va">pairs</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Ignacio Ferres, Gregorio Iraola, Institut Pasteur de Montevideo.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.6.9000.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
